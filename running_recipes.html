

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running dvas recipes &mdash; dvas  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Troubleshooting" href="troubleshooting.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            dvas
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Running dvas recipes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setup-of-a-dvas-processing-arena">Setup of a dvas processing arena</a></li>
<li class="toctree-l2"><a class="reference internal" href="#anatomy-of-the-dvas-processing-arena">Anatomy of the dvas processing arena</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-original-data-folder">The original data folder</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-configs-folder">The configs folder</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-recipe-file">The recipe file</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#execution-of-a-dvas-recipe">Execution of a dvas recipe</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledge.html">Acknowledging dvas</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License &amp; Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/MeteoSwiss-MDA/dvas">Github repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">dvas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Running dvas recipes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/running_recipes.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="running-dvas-recipes">
<span id="running"></span><h1>Running dvas recipes<a class="headerlink" href="#running-dvas-recipes" title="Link to this heading"></a></h1>
<p>dvas recipes are pre-packaged, pre-configured analysis pipelines, designed to perform
<strong>specific tasks in a specific order</strong>. Their primary purpose is to allow any official dvas analysis
to be reproduced by anyone, anywhere.</p>
<section id="setup-of-a-dvas-processing-arena">
<h2>Setup of a dvas processing arena<a class="headerlink" href="#setup-of-a-dvas-processing-arena" title="Link to this heading"></a></h2>
<p>We will here use the case of the UAII 2022 field campaign, for which a dedicated dvas recipe was
created. Once dvas has been <a class="reference internal" href="installation.html#install"><span class="std std-ref">installed</span></a>, follow these steps to reproduce the entire
UAII 2022 field campaign analysis cascade:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Initialize a new dvas <em>processing arena</em>. In a terminal, in a location of your choice, type:</p></li>
</ol>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dvas_init_arena
</pre></div>
</div>
<p>This will create a new folder <code class="docutils literal notranslate"><span class="pre">dvas_proc_arena</span></code>.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">dvas_init_arena</span> <span class="pre">--help</span></code> to see what options exist:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>usage: dvas_init_arena [-h] [--path ./a/new/folder/]

DVAS 1.2.1 - Data Visualization and Analysis Software: Initialization entry point.

options:
  -h, --help            show this help message and exit
  --path ./a/new/folder/
                        Relative path &amp; name for the new processing arena.

For more info: https://MeteoSwiss.github.io/dvas
 
</pre></div>
</div>
</div>
<p>The processing arena you just created got pre-filled with:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>a series of configuration files for the dvas database (more on this below),</p></li>
<li><p>a series of so-called <em>fid-eid</em>  <code class="docutils literal notranslate"><span class="pre">.csv</span></code> files with lists of flights, and</p></li>
<li><p>the official dvas recipe file for the UAII 2022 field campaign: <code class="docutils literal notranslate"><span class="pre">uaii22.rcp</span></code>.</p></li>
</ol>
</div></blockquote>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Fetch the flight data to be processed from the UAII 2022 Supplementary Material,
and unpack it not too far away. To be specific, you need to download and extract the
<em>organized_flight_data_for_dvas_input.tar.gz</em> element of the
<a class="reference external" href="https://doi.org/10.5281/zenodo.10160683">dataset on Zenodo</a>.</p></li>
<li><p>Verify how well dvas runs on your machine with the dedicated entry point:</p></li>
</ol>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd dvas_proc_arena
dvas_optimize
</pre></div>
</div>
<p>This command will process some mock data repeatedly, to explore which <code class="docutils literal notranslate"><span class="pre">chunk_size</span></code> value
provides the best performance. For certain costly operations, dvas can break profiles into chunks
to reduce the memory consumption (by keeping the size of the correlation matrices small). If the
chunks are too small, however, the performances will degrade because there aren’t enough cores to
process them all efficiently.</p>
<p>For example, on a 2021 MacBook Pro (16-inch) with 64 GB of RAM and an Apple M1 Max CPU with
10-cores, we find that a chunk size of ~150-200 works best, with a processing time (reported by
<code class="docutils literal notranslate"><span class="pre">dvas_optimize</span></code>) of ~1.1 seconds. By comparison, on a 2019 MacBook Pro (16-inch) with 32 GB
of RAM and a 2.3 GHz 8-core Intel Core i9 CPU, we find the same ideal chunk size of ~150, but with
a processing time of ~2.4 seconds.</p>
</div></blockquote>
</div></blockquote>
<p>You now have all the elements required to run the dvas recipe for the UAII 2022 field camapign.
Time to take a closer look at the …</p>
</section>
<section id="anatomy-of-the-dvas-processing-arena">
<h2>Anatomy of the dvas processing arena<a class="headerlink" href="#anatomy-of-the-dvas-processing-arena" title="Link to this heading"></a></h2>
<p>There are 3 main components to a dvas processing arena: the
<a class="reference internal" href="#original-data"><span class="std std-ref">original data</span></a>,
the <a class="reference internal" href="#config-data"><span class="std std-ref">database configs files</span></a>,
and the <a class="reference internal" href="#recipe-file"><span class="std std-ref">recipe file</span></a>. Let’s take a closer look at each of these.</p>
<section id="the-original-data-folder">
<span id="original-data"></span><h3>The original data folder<a class="headerlink" href="#the-original-data-folder" title="Link to this heading"></a></h3>
<p>This folder contains all the original data to be processed. The actual structuring of subfolders
inside it does not actually matter to dvas. Note, however, the following restriction:</p>
<blockquote>
<div><ul class="simple">
<li><p>for non-GDP radiosondes: a <code class="docutils literal notranslate"><span class="pre">.yml</span></code> text file <strong>with the same name</strong> as the original data file
must be specified for all datasets. These <code class="docutils literal notranslate"><span class="pre">.yml</span></code> files must contain all the metadata not
otherwise present in the original data files.</p></li>
</ul>
</div></blockquote>
<p>The data folder included in the UAII 2022 Supplementary Material already contains all the necessary
metadata files - no need to change anything there.</p>
</section>
<section id="the-configs-folder">
<span id="config-data"></span><h3>The configs folder<a class="headerlink" href="#the-configs-folder" title="Link to this heading"></a></h3>
<p>This folder contains all the information required to setup the dvas database, and have it ingest all
the original data correctly. Modifying these files is only required if one wishes to include
datasets that differ from those already supported by dvas.</p>
</section>
<section id="the-recipe-file">
<span id="recipe-file"></span><h3>The recipe file<a class="headerlink" href="#the-recipe-file" title="Link to this heading"></a></h3>
<p>The dvas recipes are described in YAML files with the <code class="docutils literal notranslate"><span class="pre">.rcp</span></code> extension. In there, you will find
general recipe parameters, including the list of variable names to process, together with the list
of all the processing steps and their associated parameters. All these steps refer to high-level
routines and modules from the <code class="docutils literal notranslate"><span class="pre">dvas_recipes</span></code> sub-package, that themselves rely on core <code class="docutils literal notranslate"><span class="pre">dvas</span></code>
modules and functions.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">uaii2022.rcp</span></code> contains all the instructions required the reproduce the official data analysis
of the UAII 2022 field campaign described in the Final Report. This file also contains the different
recipe parameters, some of which must be changed to reflect your specific setup:</p>
<blockquote>
<div><p>1. Set <code class="docutils literal notranslate"><span class="pre">rcp_paths:orig_data_path:sub_path</span></code> to point to the location where you unpacked the
campaign data. If you followed the instructions above, the line should read:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">sub_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./original_data/day_flights</span>
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>We <strong>strongly</strong> recommand to process night and day flights separately to limit the memory use.</p>
</div>
<p>2. Set the name of the person/institution running the recipe under
<code class="docutils literal notranslate"><span class="pre">rcp_params:general:institution</span></code>, that will appear in the global attribute <code class="docutils literal notranslate"><span class="pre">institution</span></code>
in the NetCDF files created by dvas:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">institution</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;inst_name</span><span class="w"> </span><span class="s">&#39;J.</span><span class="nv"> </span><span class="s">Doe,</span><span class="nv"> </span><span class="s">Sirius</span><span class="nv"> </span><span class="s">Cybernetics&#39;</span>
</pre></div>
</div>
<p>3. [If warranted] Adjust the <code class="docutils literal notranslate"><span class="pre">rcp_params:general:chunk_size:</span></code> to the value reported by the
<code class="docutils literal notranslate"><span class="pre">dvas_optimize</span></code> command.</p>
<ol class="arabic simple" start="4">
<li><p>Uncomment the appropriate time-of-day (<code class="docutils literal notranslate"><span class="pre">tods</span></code>) line under step 10:</p></li>
</ol>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">tods</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">daytime</span>
<span class="w">  </span><span class="c1">#- [nighttime, twilight]</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="execution-of-a-dvas-recipe">
<h2>Execution of a dvas recipe<a class="headerlink" href="#execution-of-a-dvas-recipe" title="Link to this heading"></a></h2>
<p>With a dedicated dvas processing arena in place, and the parameters of the UAII 2022 recipe adjusted
to your specific system, you should now be able to launch the data processing.</p>
<p>To do so, use the <code class="docutils literal notranslate"><span class="pre">dvas_run_recipe</span></code> entry point from the command line:</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd dvas_proc_arena
dvas_run_recipe uaii22.rcp uaii2022_fid-eid-rid-edt_day.csv -s &#39;00&#39; -e &#39;10&#39;
</pre></div>
</div>
</div></blockquote>
<p>This will trigger the <code class="docutils literal notranslate"><span class="pre">uaii2022.rcp</span></code> recipe, for the flights specified in the
<code class="docutils literal notranslate"><span class="pre">uaii2022_fid-eid-rid-edt_day.csv</span></code> file <a class="footnote-reference brackets" href="#f1" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, starting with step <code class="docutils literal notranslate"><span class="pre">00</span></code> and ending with step <code class="docutils literal notranslate"><span class="pre">10</span></code>.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Before launching the full processing, you may want to try running the first step only, with
<code class="docutils literal notranslate"><span class="pre">dvas_run_recipe</span> <span class="pre">uaii22.rcp</span> <span class="pre">uaii2022_fid-eid-rid-edt_day.csv</span> <span class="pre">-s</span> <span class="pre">'00'</span> <span class="pre">-e</span> <span class="pre">'00'</span></code></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Under Windows, you may need to skip the <code class="docutils literal notranslate"><span class="pre">'</span> <span class="pre">'</span></code> quotes around the step ids (see <a class="reference external" href="https://stackoverflow.com/questions/13168666">this post</a> on StackOverflow).</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Be aware that running the entire UAII 2022 field campaign analysis takes a long time. On a
2021 MacBook Pro (16-inch) with 64 GB RAM and an Apple M1 Max CPU with 10 cores,
<strong>the processing of daytime flights takes 62.5 hours</strong> (51.7 hours for the nighttime flights).</p>
</div>
<p class="rubric">Footnotes</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="f1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>See <a class="reference external" href="https://github.com/MeteoSwiss/dvas/issues/243">this issue</a> for a discussion of why this file is required.</p>
</aside>
</aside>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="troubleshooting.html" class="btn btn-neutral float-right" title="Troubleshooting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2023, MeteoSwiss.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>